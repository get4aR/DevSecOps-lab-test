name: lab4-workflow

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  schedule:
    - cron: '0 9 * * 5'  # Каждую пятницу, 9:00 UTC

jobs:
  lint-and-tests-jobuh:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13.7'

    - name: Install requirements such as flake8, pytest, ruff, bandit
      run: |
        pip install flake8 pytest ruff bandit
        if [ -f backend/requirements.txt ]; then pip install -r backend/requirements.txt; fi

    - name: Run flake8
      run: |
        flake8 ./backend --count --max-line-length=127

    - name: Run tests
      run: |
        python -m pytest tests.py -v
    
  hadolint-jobuh:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Run Hadolint Backend
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: backend/Dockerfile
        format: json
        output-file: hadolint-backend-report.json

    - name: Upload hadolint backend report
      uses: actions/upload-artifact@v4
      with:
        name: hadolint-backend-report.json
        path: hadolint-backend-report.json
    
    - name: Run Hadolint Nginx
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: nginx/Dockerfile
        format: json
        output-file: hadolint-nginx-report.json

    - name: Upload hadolint nginx report
      uses: actions/upload-artifact@v4
      with:
        name: hadolint-nginx-report.json
        path: hadolint-nginx-report.json

  trivy-jobuh:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build images
        run: docker compose build

      - name: Run Trivy on backend
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'devsecops-lab-test-backend'
          format: 'json'
          output: 'trivy-report.json'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Upload Trivy report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy-report.json

      - name: Start stack
        run: |
          docker compose up -d
          
          timeout=120
          while [ $timeout -gt 0 ]; do
            if curl -fsS http://localhost:80/ > /dev/null 2>&1; then
              echo "START SUCCESS"
              break
            fi
            sleep 1
            timeout=$((timeout - 1))
          done
          
          if [ $timeout -eq 0 ]; then
            echo "START FAILED"
            docker compose logs backend
            exit 1
          fi

      - name: Verify HTTP 200
        run: |
          status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:80/healthcheck)
          echo "Healthcheck status: $status"
          if [ "$status" != "200" ]; then
            echo "Expected 200, got $status"
            docker compose logs backend
            exit 1
          fi
          echo "Healthy oh yeah"

      - name: Cleanup
        if: always()
        run: docker compose down -v

  ruff-jobuh:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13.7'

    - name: Install ruff
      run: pip install ruff

    - name: Run ruff
      run: |
        ruff check ./backend --output-format json > ruff-report.json
        ruff format ./backend --check

    - name: Upload ruff report
      uses: actions/upload-artifact@v4
      with:
        name: ruff-report
        path: ruff-report.json

  bandit-jobuh:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13.7'

    - name: Install bandit
      run: pip install bandit

    - name: Run bandit
      run: |
        bandit -r ./backend -f json -o bandit-report.json

    - name: Upload bandit report
      uses: actions/upload-artifact@v4
      with:
        name: bandit-report
        path: bandit-report.json