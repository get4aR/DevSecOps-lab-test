name: lab4-workflow

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  schedule:
    - cron: '0 9 * * 5'  # Каждую пятницу, 9:00 UTC

jobs:
  lint-and-tests-jobuh:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13.7'

    - name: Install requirements such as flake8, pytest
      run: |
        pip install flake8 pytest
        if [ -f backend/requirements.txt ]; then pip install -r backend/requirements.txt; fi

    - name: Run flake8
      run: |
        flake8 ./backend --count --max-line-length=127

    - name: Run tests
      run: |
        python -m pytest tests.py -v
    
  hadolint-jobuh:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Run Hadolint Backend
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: backend/Dockerfile
        format: json
        output-file: hadolint-backend-report.json

    - name: Upload hadolint backend report
      uses: actions/upload-artifact@v4
      with:
        name: hadolint-backend-report.json
        path: hadolint-backend-report.json
    
    - name: Run Hadolint Nginx
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: nginx/Dockerfile
        format: json
        output-file: hadolint-nginx-report.json

    - name: Upload hadolint nginx report
      uses: actions/upload-artifact@v4
      with:
        name: hadolint-nginx-report.json
        path: hadolint-nginx-report.json

  trivy-jobuh:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build images
        run: docker compose build

      - name: Run Trivy on backend
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'devsecops-lab-test-backend'
          format: 'json'
          output: 'trivy-report.json'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Upload Trivy report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy-report.json

      - name: Start stack
        run: |
          docker compose up -d
          
          timeout=120
          while [ $timeout -gt 0 ]; do
            if curl -fsS http://localhost:80/ > /dev/null 2>&1; then
              echo "START SUCCESS"
              break
            fi
            sleep 1
            timeout=$((timeout - 1))
          done
          
          if [ $timeout -eq 0 ]; then
            echo "START FAILED"
            docker compose logs backend
            exit 1
          fi

      - name: Verify HTTP 200
        run: |
          status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:80/healthcheck)
          echo "Healthcheck status: $status"
          if [ "$status" != "200" ]; then
            echo "Expected 200, got $status"
            docker compose logs backend
            exit 1
          fi
          echo "Healthy oh yeah"

      - name: Cleanup
        if: always()
        run: docker compose down -v

  ruff-jobuh:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13.7'

    - name: Install ruff
      run: pip install ruff

    - name: Run ruff
      run: |
        ruff check ./backend --output-format json > ruff-report.json

    - name: Upload ruff report
      uses: actions/upload-artifact@v4
      with:
        name: ruff-report
        path: ruff-report.json

  bandit-jobuh:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13.7'

    - name: Install bandit
      run: pip install bandit

    - name: Run bandit
      run: |
        bandit -r ./backend -f json -o bandit-report.json

    - name: Upload bandit report
      uses: actions/upload-artifact@v4
      with:
        name: bandit-report
        path: bandit-report.json

  summary_report:
    needs: [lint-and-tests-jobuh, trivy-jobuh, ruff-jobuh, bandit-jobuh, hadolint-jobuh]
    runs-on: ubuntu-latest

    steps:
      - name: Download reports
        uses: actions/download-artifact@v4
        with:
          path: reports

      - name: Install jq
        run: sudo apt-get update -y && sudo apt-get install -y jq

      - name: Create summary report
        run: |
          REPORT=summary_report.md
          echo "# Lab 4 summary report" > "$REPORT"
          echo "" >> "$REPORT"

          # ---------- Flake8 / Pytest ----------
          echo "## Flake8 / Pytest" >> "$REPORT"
          echo '```
          if [ -s reports/flake8-report/flake8-report.txt ]; then
            echo "Flake8: найдены замечания, см. подробный отчет:" >> "$REPORT"
            cat reports/flake8-report/flake8-report.txt >> "$REPORT"
          else
            echo "Flake8: нарушений стиля не обнаружено." >> "$REPORT"
          fi
          echo "" >> "$REPORT"
          if [ -s reports/pytest-report/pytest-report.txt ]; then
            echo "" >> "$REPORT"
            echo "Pytest: результаты тестов:" >> "$REPORT"
            cat reports/pytest-report/pytest-report.txt >> "$REPORT"
          else
            echo "Pytest: отчет отсутствует или пуст." >> "$REPORT"
          fi
          echo '```' >> "$REPORT"
          echo "" >> "$REPORT"

          # ---------- Ruff ----------
          echo "## Ruff (стиль Python)" >> "$REPORT"
          echo '```
          if [ -s reports/ruff-report/ruff-report.json ]; then
            RUFF_TOTAL=$(jq 'length' reports/ruff-report/ruff-report.json 2>/dev/null || echo 0)
            echo "Всего найдено предупреждений: ${RUFF_TOTAL}." >> "$REPORT"
            echo "Подробный JSON-отчет см. в артефакте ruff-report." >> "$REPORT"
          else
            echo "Ruff: отчет не найден, критичных замечаний нет." >> "$REPORT"
          fi
          echo '```' >> "$REPORT"
          echo "" >> "$REPORT"

          # ---------- Bandit ----------
          echo "## Bandit (безопасность Python-кода)" >> "$REPORT"
          echo '```
          if [ -s reports/bandit-report/bandit-report.json ]; then
            BANDIT_TOTAL=$(jq '.results | length' reports/bandit-report/bandit-report.json 2>/dev/null || echo 0)
            BANDIT_HIGH=$(jq '[.results[] | select(.issue_severity=="HIGH")] | length' reports/bandit-report/bandit-report.json 2>/dev/null || echo 0)
            echo "Всего найдено потенциальных проблем: ${BANDIT_TOTAL}, из них HIGH: ${BANDIT_HIGH}." >> "$REPORT"
            echo "Детали доступны в JSON-отчете arтефакта bandit-report." >> "$REPORT"
          else
            echo "Bandit: отчет отсутствует, проблем не зафиксировано." >> "$REPORT"
          fi
          echo '```' >> "$REPORT"
          echo "" >> "$REPORT"

          # ---------- Hadolint ----------
          echo "## Hadolint (Dockerfile’ы backend и nginx)" >> "$REPORT"
          echo '```
          BACKEND_ISSUES=$(jq 'length' reports/hadolint-backend-report.json 2>/dev/null || echo 0)
          NGINX_ISSUES=$(jq 'length' reports/hadolint-nginx-report.json 2>/dev/null || echo 0)
          TOTAL_HADOLINT=$((BACKEND_ISSUES + NGINX_ISSUES))
          echo "Всего замечаний: ${TOTAL_HADOLINT} (backend: ${BACKEND_ISSUES}, nginx: ${NGINX_ISSUES})." >> "$REPORT"
          echo "Полные JSON-отчеты: hadolint-backend-report.json и hadolint-nginx-report.json." >> "$REPORT"
          echo '```' >> "$REPORT"
          echo "" >> "$REPORT"

          # ---------- Trivy ----------
          echo "## Trivy (уязвимости контейнерного образа)" >> "$REPORT"
          echo '```
          if [ -s reports/trivy-report/trivy-report.json ]; then
            TRIVY_TOTAL=$(jq '.Results.Vulnerabilities | length' reports/trivy-report/trivy-report.json 2>/dev/null || echo 0)
            TRIVY_CRIT=$(jq '[.Results.Vulnerabilities[] | select(.Severity=="CRITICAL")] | length' reports/trivy-report/trivy-report.json 2>/dev/null || echo 0)
            TRIVY_HIGH=$(jq '[.Results.Vulnerabilities[] | select(.Severity=="HIGH")] | length' reports/trivy-report/trivy-report.json 2>/dev/null || echo 0)
            echo "Всего уязвимостей: ${TRIVY_TOTAL}, CRITICAL: ${TRIVY_CRIT}, HIGH: ${TRIVY_HIGH}." >> "$REPORT"
            echo "Подробности см. в trivy-report.json." >> "$REPORT"
          else
            echo "Trivy: отчет не найден, уязвимости в данном прогоне не зафиксированы." >> "$REPORT"
          fi
          echo '```' >> "$REPORT"
          echo "" >> "$REPORT"

      - name: Upload summary report
        uses: actions/upload-artifact@v4
        with:
          name: summary_report
          path: summary_report.md